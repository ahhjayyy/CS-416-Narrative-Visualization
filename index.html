<!DOCTYPE html>
<html>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.js"></script>
  <head>
    <style>
      h1 {
        text-align: center;
      }
      h2 {
        text-align: center;
      }
      svg {
        display: block;
        margin: auto;
      }

      body {
        height: 100%;
        width: 100%;
      }
      canvas {
        background-color: wheat;
        display: block;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100%;
        width: 100%;
      }
    </style>
    <title>Social Insurance Projections</title>
    <h1>Social Insurance Projections</h1>
    <h2>
      What is the Social Safety Net in the United States expected to look like
      in 75 years?<br />
      We examine the projections for the four primary social insurance
      categories: Social Security, Medicare Part A, Medicare Part B, and
      Medicare Part D.
    </h2>
  </head>
  <div id="my_dataviz"></div>

  <body onload="init()">
    <script>
      async function init() {
        data = await d3.csv("USFR_StmtSocIns_20191001_20240930.csv", (d) => {
          return {
            ...d,
          };
        });
        // Filter data to only include present value for each social insurance category
        pv_data = data.filter(
          (u) =>
            u["Account Description"].includes(
              "Present value of future expenditures in excess of future revenue"
            )
          //&& u["Calendar Year"] == 2024
        );
        console.log(pv_data);
        var margin = { top: 50, right: 30, bottom: 30, left: 60 },
          width = 1200 - margin.left - margin.right,
          height = 800 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3
          .select("#my_dataviz")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        var allGroup = [
          "Federal Old-Age, Survivors and Disability Insurance (Social Security)",
          "Federal Hospital Insurance (Medicare Part A)",
          "Federal Supplementary Medical Insurance (Medicare Part B)",
          "Federal Supplementary Medical Insurance (Medicare Part D)",
          // "Total present value of future expenditures in excess of future revenue",
        ];

        var dataReady = allGroup.map(function (grpName) {
          // .map allows to do something for each element of the list
          return {
            name: grpName,
            values: pv_data
              .map(function (d) {
                if (d["Program Description"] == grpName)
                  return {
                    date: d["Calendar Year"],
                    value: +d["Projection Amount (in Trillions)"],
                  };
              })
              .filter(function (elt) {
                return elt != undefined;
              }),
          };
        });
        console.log(dataReady);

        // Annotations
        const type = d3.annotationCalloutCircle;
        const typeline = d3.annotationCalloutCurve;

        const annotations = [
          {
            note: {
              label:
                "Within just 5 years, the projection for Social Security has fallen a further $5 trillion into the red. Without significant changes to allocation, the program will be $25 trillion in debt by 2099.",
              wrap: 300,
              title: "A bleak outlook for Social Security",
            },
            //can use x, y directly instead of data
            x: 1110,
            y: 292,
            dy: 30,
            dx: -100,
            subject: {
              radius: 20,
              radiusPadding: 5,
            },
          },
        ];

        const prompt_annotations = [
          {
            note: {
              // label:
              //   "Click to learn more",
              // wrap: 300,
              title: "Click to learn more",
            },
            //can use x, y directly instead of data
            x: 900,
            y: 100,
            dy: 30,
            dx: 0,
            color: "black",
            connector: { points: 0, end: "arrow" },
            subject: {
              radius: 20,
              radiusPadding: 5,
            },
          },
        ];

        const makeAnnotations = d3
          .annotation()
          //also can set and override in the note.padding property
          //of the annotation object
          .notePadding(15)
          .type(type)
          //accessors & accessorsInverse not needed
          //if using x, y in annotations JSON
          .annotations(annotations);

        svg.append("g").attr("class", "annotation-group").call(makeAnnotations);

        const lineAnnotations = d3
          .annotation()
          //also can set and override in the note.padding property
          //of the annotation object
          .notePadding(15)
          .type(typeline)
          //accessors & accessorsInverse not needed
          //if using x, y in annotations JSON
          .annotations(prompt_annotations);

        svg.append("g").attr("class", "annotation-group").call(lineAnnotations);

        // create a tooltip
        var Tooltip = d3
          .select("#my_dataviz")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")
          .style("position", "absolute");

        // Three function that change the tooltip when user hover / move / leave a cell
        var point_mouseover = function (evt, d) {
          Tooltip.style("opacity", 1);
          d3.select(this).style("stroke", "black").style("opacity", 1);
        };
        var point_mousemove = function (evt, d) {
          const [mx, my] = d3.pointer(this);
          Tooltip.html(
            `75-year projection in ${d.date}:<br> $${d.value} trillion`
          )
            .style("left", evt.layerX + 375 + "px")
            // mx OR d3.pointer(this)[0]
            .style("top", evt.layerY + 200 + "px");
        };
        var point_mouseleave = function (evt, d) {
          Tooltip.style("opacity", 0);
          d3.select(this).style("stroke", "none").style("opacity", 0.8);
        };
        var line_mouseclick = function (evt, d) {
          console.log(d.name);
          if (d.name == "Federal Hospital Insurance (Medicare Part A)") {
            window.location.href = "medicare_part_a.html";
          } else if (
            d.name ==
            "Federal Supplementary Medical Insurance (Medicare Part B)"
          ) {
            window.location.href = "medicare_part_b.html";
          } else if (
            d.name ==
            "Federal Supplementary Medical Insurance (Medicare Part D)"
          ) {
            window.location.href = "medicare_part_d.html";
          } else if (
            d.name ==
            "Federal Old-Age, Survivors and Disability Insurance (Social Security)"
          ) {
            window.location.href = "socsec.html";
          }
        };

        var myColor = d3.scaleOrdinal().domain(allGroup).range(d3.schemeSet2);

        // resize axis, keep graph within bounds of svg
        // Add X axis
        var x = d3.scaleLinear().domain([2020, 2024]).range([0, width]);
        svg
          .append("g")
          .attr("transform", "translate(0,0)")
          .call(
            d3
              .axisTop(x)
              .tickValues([2020, 2021, 2022, 2023, 2024])
              .tickFormat(d3.format(".4"))
          );
        svg
          .append("text")
          .attr("class", "x label")
          .attr("text-anchor", "end")
          .attr("x", width / 2 + 15)
          .attr("y", -35)
          .text("Year");
        // Add Y axis
        var y = d3
          .scaleLinear()
          .domain([-50, 0])
          .range([height / 1.25, 0]);
        svg.append("g").call(d3.axisLeft(y), y("Present Value (in Trillions)"));

        svg
          .append("text")
          .attr("class", "y label")
          .attr("text-anchor", "end")
          .attr("x", -(height / 2) + 15)
          .attr("y", -50)
          .attr("dy", "0.75em")
          .attr("transform", "rotate(-90)")
          .text("Present Value (in Trillions)");

        // Add the lines
        var line = d3
          .line()
          .x(function (d) {
            return x(d.date);
          })
          .y(function (d) {
            return y(+d.value);
          });
        svg
          .selectAll("myLines")
          .data(dataReady)
          .enter()
          .append("path")
          .attr("d", function (d) {
            return line(d.values);
          })
          .attr("stroke", function (d) {
            return myColor(d.name);
          })
          .style("stroke-width", 4)
          .style("fill", "none")
          .on("click", line_mouseclick);

        // svg.select("myLines:nth-child(1)").on("click", medicarea_mouseclick);
        // Add the points
        svg
          // First we need to enter in a group
          .selectAll("myDots")
          .data(dataReady)
          .enter()
          .append("g")
          .style("fill", function (d) {
            return myColor(d.name);
          })
          // Second we need to enter in the 'values' part of this group
          .selectAll("myPoints")
          .data(function (d) {
            return d.values;
          })
          .enter()
          .append("circle")
          .attr("cx", function (d) {
            return x(d.date);
          })
          .attr("cy", function (d) {
            return y(d.value);
          })
          .attr("r", 5)
          .attr("stroke", "white")
          .on("mouseover", point_mouseover)
          .on("mousemove", point_mousemove)
          .on("mouseleave", point_mouseleave);

        svg
          .selectAll("mydots")
          .data(dataReady)
          .enter()
          .append("circle")
          .attr("cx", 0)
          .attr("cy", function (d, i) {
            return 595 + i * 25;
          }) // 100 is where the first dot appears. 25 is the distance between dots
          .attr("r", 7)
          .style("fill", function (d) {
            return myColor(d.name);
          });

        svg
          .selectAll("myLegend")
          .data(dataReady)
          .enter()
          .append("text")
          .attr("x", 20)
          .attr("y", function (d, i) {
            return 600 + i * 25;
          }) // 100 is where the first dot appears. 25 is the distance between dots
          .style("fill", function (d) {
            return myColor(d.name);
          })
          .text(function (d) {
            return d.name;
          })
          .attr("text-anchor", "left")
          .style("alignment-baseline", "middle")
          .on("click", function (d) {
            // is the element currently visible ?
            currentOpacity = d3.selectAll("." + d.name).style("opacity");
            // Change the opacity: from 0 to 1 or from 1 to 0
            d3.selectAll("." + d.name)
              .transition()
              .style("opacity", currentOpacity == 1 ? 0 : 1);
          });
      }

      async function MedicarePartA() {
        data = await d3.csv("USFR_StmtSocIns_20191001_20240930.csv", (d) => {
          return {
            ...d,
          };
          // d3.select(id).html = "" .append()
        });
      }
    </script>
  </body>
</html>
