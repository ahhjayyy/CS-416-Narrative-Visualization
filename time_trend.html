<!DOCTYPE html>
<html>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.js"></script>
  <head>
    <style>
      h1,
      h2 {
        text-align: center;
        color: #2a3a5e;
      }
      /* h2 {
        text-align: center;
      } */
      svg {
        display: block;
        margin: auto;
        /* cursor: pointer; */
      }

      body {
        font-family: "Segoe UI", "Roboto", Arial, sans-serif;
        background: #fbf9f7;
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        /* cursor: pointer; */
      }
      canvas {
        /* background-color: wheat; */
        display: block;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100%;
        width: 100%;
        /* cursor: pointer; */
      }
      .myLines {
        cursor: pointer;
      }

      .button,
      .button2 {
        background-color: #07beb8;
        color: white;
        border: none;
        /* padding: 16px 32px; */
        border-radius: 8px;
        font-size: 16px;
        /* margin-top: 24px; */
        transition: background 0.2s, color 0.2s;
        width: 100%;
        cursor: pointer;
      }

      .button2 {
        background: white;
        color: #07beb8;
        padding: 16px 32px;
        border: 2px solid #07beb8;
        margin-top: 24px;
      }

      .button3 {
        background: white;
        color: #07beb8;
        border: 2px solid #07beb8;
        padding: 16px 16px;
        border-radius: 8px;
        font-size: 16px;
        margin-top: 0px;
        transition: background 0.2s, color 0.2s;
        width: 100%;
        cursor: pointer;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 16px 16px;
        width: 100%;
        margin-bottom: 0;
      }
      .button-group .button3 {
        width: 100%;
        margin-top: 0;
      }

      .button2:hover,
      .button:hover {
        background: #111d4a;
        color: #fff;
      }

      input[type="range"] {
        width: 300px;
        accent-color: #07beb8;
        margin-top: 16px;
      }

      .node:hover {
        stroke-width: 7px !important;
        opacity: 1 !important;
      }
      .tooltip {
        position: absolute;
        pointer-events: "cursor";
        z-index: 10;
        background: #fff;
        border: 1px solid #07beb8;
        border-radius: 8px;
        padding: 12px 18px;
        font-size: 16px;
        color: #2a3a5e;
        box-shadow: 0 2px 8px rgba(61, 125, 255, 0.08);
        transition: opacity 0.2s;
      }

      #main-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: flex-start;
        gap: 40px;
        /* margin-top: 30px; */
        margin: 40px auto 0 auto;
        max-width: 1400px;
      }

      #my_dataviz {
        flex: 2 1 0;
        /* min-width: 600px; */
        align-items: center;
        background: #fff;
        border-radius: 16px;
        margin-left: 50px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
        padding: 0;
        padding-top: 20px;
      }

      #info-box {
        flex: 1 1 0;
        background: #f5f8ff;
        border-radius: 16px;
        border-left: 6px solid #111d4a;
        background: linear-gradient(135deg, #b2e1e8 80%, #98dfea 100%);
        padding: 32px 24px;
        min-width: 400px;
        max-width: 800px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
        margin-left: 0px;
        margin-right: 50px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      #info-box h2 {
        margin-top: 0;
        color: #111d4a;
      }

      #info-box button {
        margin-top: 32px;
        width: 100%;
      }

      @media (max-width: 1000px) {
        #main-container {
          flex-direction: column;
          align-items: center;
          gap: 20px;
        }
        #my_dataviz,
        #info-box {
          min-width: 90vw;
          max-width: 98vw;
        }
      }
    </style>
    <h1>Year-over-Year Projections</h1>
    <h2>What can trends tell us about how the projections are changing?</h2>
  </head>
  <!-- <div id="my_dataviz"></div> -->
  <!-- <button class="button button2" onclick="history.back()">Go Back</button> -->
  <body onload="init()">
    <div id="main-container">
      <div id="my_dataviz"></div>
      <div id="info-box">
        <h2>About These Projections</h2>
        <p>
          This line chart shows the year-over-year trends for projected present
          value of the four programs, 75 years from the projection date. Notice
          that the y-axis is negative, meaning that the lower a value, the
          further in the red the projection is.
          <br />
          <br />
          While the projection for Federal Hospital Insurance (Medicare Part A)
          is slightly improving, Medicare Part D is stagnant and Part B & Social
          Security are declining rapidly. This brings forth the question: why
          are certain programs having worse projections year-over-year? Is
          revenue declining, or are expenditures rising? What can be done to
          address it?
          <br />
          <br />
          <i
            >Hover over the points on the graph to see the projected loss in
            trillions of dollars for each program in each year. Click on the
            lines to explore the breakdown between revenue and expenditures
            further. Alternatively, click on the buttons below to view these
            breakdowns.</i
          >
        </p>
        <div class="button-group">
          <button class="button button3" id="medi_a">Medicare Part A</button>
          <button class="button button3" id="medi_b">Medicare Part B</button>
          <button class="button button3" id="medi_d">Medicare Part D</button>
          <button class="button button3" id="soc_sec">Social Security</button>
        </div>
        <button class="button button2" onclick="history.back()">Go Back</button>
      </div>
    </div>
    <footer
      style="
        text-align: center;
        color: #b0b8c9;
        font-size: 14px;
        margin: 32px 0 8px 0;
      "
    >
      Data: U.S. Department of the Treasury, Bureau of the Fiscal Service
      &mdash; Financial Report of the United States Government: Statements of
      Social Insurance
    </footer>
    <script>
      async function init() {
        data = await d3.csv("USFR_StmtSocIns_20191001_20240930.csv", (d) => {
          return {
            ...d,
          };
        });
        // Filter data to only include present value for each social insurance category
        pv_data = data.filter(
          (u) =>
            u["Account Description"].includes(
              "Present value of future expenditures in excess of future revenue"
            )
          //&& u["Calendar Year"] == 2024
        );
        // console.log(pv_data);
        var margin = { top: 50, right: 30, bottom: 30, left: 60 },
          width = 1200 - margin.left - margin.right,
          height = 750 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3
          .select("#my_dataviz")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        // Make the SVG responsive
        svg
          .attr("viewBox", `0 0 ${width} ${height}`)
          .attr("preserveAspectRatio", "xMidYMid meet");

        svg
          .selectAll("rect")
          .attr("width", 0)
          .transition()
          .delay(function (d, i) {
            return i * 50;
          })
          .duration(1000)
          .attr("width", function (d) {
            return d.amount * 10;
          });

        var allGroup = [
          "Federal Old-Age, Survivors and Disability Insurance (Social Security)",
          "Federal Hospital Insurance (Medicare Part A)",
          "Federal Supplementary Medical Insurance (Medicare Part B)",
          "Federal Supplementary Medical Insurance (Medicare Part D)",
          // "Total present value of future expenditures in excess of future revenue",
        ];

        var dataReady = allGroup.map(function (grpName) {
          // .map allows to do something for each element of the list
          return {
            name: grpName,
            values: pv_data
              .map(function (d) {
                if (d["Program Description"] == grpName)
                  return {
                    date: d["Calendar Year"],
                    prog_desc: d["Program Description"],
                    value: +d["Projection Amount (in Trillions)"],
                  };
              })
              .filter(function (elt) {
                return elt != undefined;
              }),
          };
        });
        // console.log(dataReady);

        // Annotations
        const type = d3.annotationCalloutCircle;
        const typeline = d3.annotationCalloutCurve;

        const annotations = [
          {
            note: {
              label:
                "Within just 5 years, the projection for Social Security has fallen a further $5 trillion into the red. Without significant changes to allocation, the program will be $25 trillion in debt by 2099.",
              wrap: 300,
              title: "A bleak outlook for Social Security",
            },
            //can use x, y directly instead of data
            x: 1110,
            y: 270,
            dy: 20,
            dx: -100,
            subject: {
              radius: 20,
              radiusPadding: 5,
            },
          },
        ];

        const prompt_annotations = [
          {
            note: {
              // label:
              //   "Click to learn more",
              wrap: 150,
              title: "Click the lines to learn more about specific programs",
            },
            //can use x, y directly instead of data
            x: 900,
            y: 100,
            dy: 30,
            dx: 0,
            color: "black",
            connector: { points: 0, end: "arrow" },
            subject: {
              radius: 20,
              radiusPadding: 5,
            },
          },
        ];

        const makeAnnotations = d3
          .annotation()
          //also can set and override in the note.padding property
          //of the annotation object
          .notePadding(15)
          .type(type)
          //accessors & accessorsInverse not needed
          //if using x, y in annotations JSON
          .annotations(annotations);

        svg.append("g").attr("class", "annotation-group").call(makeAnnotations);
        const lineAnnotations = d3
          .annotation()
          //also can set and override in the note.padding property
          //of the annotation object
          .notePadding(15)
          .type(typeline)
          //accessors & accessorsInverse not needed
          //if using x, y in annotations JSON
          .annotations(prompt_annotations);

        svg.append("g").attr("class", "annotation-group").call(lineAnnotations);

        // create a tooltip
        var Tooltip = d3
          .select("#my_dataviz")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")
          .style("position", "absolute");

        // Three function that change the tooltip when user hover / move / leave a cell
        var point_mouseover = function (evt, d) {
          Tooltip.style("opacity", 1);
          d3.select(this)
            .style("stroke", "black")
            .style("opacity", 1)
            .style("cursor", "pointer");
        };
        var point_mousemove = function (evt, d) {
          const [mx, my] = d3.pointer(this);
          Tooltip.html(
            `75-year projection in ${d.date}:<br> $${d.value} trillion`
          )
            .style("left", evt.pageX + 20 + "px")
            // mx OR d3.pointer(this)[0]
            .style("top", evt.pageY - 20 + "px");
        };
        var point_mouseleave = function (evt, d) {
          Tooltip.style("opacity", 0);
          d3.select(this).style("stroke", "white").style("opacity", 0.8);
        };
        var line_mouseover = function (evt, d) {
          Tooltip.style("opacity", 1);
          d3.select(this)
            // .style("stroke", "black")
            // .style("opacity", 1)
            .style("cursor", "pointer");
        };
        var line_mousemove = function (evt, d) {
          Tooltip.html(`75-year projection trend for ${d.name}`)
            .style("left", evt.pageX + 20 + "px")
            .style("top", evt.pageY - 20 + "px");
        };
        var line_mouseleave = function (evt, d) {
          Tooltip.style("opacity", 0);
          d3.select(this).style("opacity", 0.8);
        };
        var line_mouseclick = function (evt, d) {
          // console.log(d.name);
          if (d.name == "Federal Hospital Insurance (Medicare Part A)") {
            window.location.href = "medicare_part_a.html";
          } else if (
            d.name ==
            "Federal Supplementary Medical Insurance (Medicare Part B)"
          ) {
            window.location.href = "medicare_part_b.html";
          } else if (
            d.name ==
            "Federal Supplementary Medical Insurance (Medicare Part D)"
          ) {
            window.location.href = "medicare_part_d.html";
          } else if (
            d.name ==
            "Federal Old-Age, Survivors and Disability Insurance (Social Security)"
          ) {
            window.location.href = "socsec.html";
          }
        };

        var myColor = d3.scaleOrdinal().domain(allGroup).range(d3.schemeSet2);

        // resize axis, keep graph within bounds of svg
        // Add X axis
        var x = d3.scaleLinear().domain([2020, 2024]).range([0, width]);
        svg
          .append("g")
          .attr("transform", "translate(0,0)")
          .call(
            d3
              .axisTop(x)
              .tickValues([2020, 2021, 2022, 2023, 2024])
              .tickFormat(d3.format(".4"))
          );
        svg
          .append("text")
          .attr("class", "x label")
          .attr("text-anchor", "end")
          .attr("x", width / 2 + 15)
          .attr("y", -35)
          .text("Year");
        // Add Y axis
        var y = d3
          .scaleLinear()
          .domain([-50, 0])
          .range([height / 1.25, 0]);
        svg.append("g").call(d3.axisLeft(y), y("Present Value (in Trillions)"));

        svg
          .append("text")
          .attr("class", "y label")
          .attr("text-anchor", "middle")
          .attr("x", -(height / 2) + 50)
          .attr("y", -50)
          .attr("dy", "0.25em")
          .attr("transform", "rotate(-90)")
          .text("Present Value (in Trillions)");

        // Add the lines
        var line = d3
          .line()
          .x(function (d) {
            return x(d.date);
          })
          .y(function (d) {
            return y(+d.value);
          });
        svg
          .selectAll("myLines")
          .data(dataReady)
          .enter()
          .append("path")
          .attr("d", function (d) {
            return line(d.values);
          })
          .attr("stroke", function (d) {
            return myColor(d.name);
          })
          .style("stroke-width", 4)
          .style("fill", "none")
          .on("click", line_mouseclick)
          .on("mouseover", line_mouseover)
          .on("mousemove", line_mousemove)
          .on("mouseleave", line_mouseleave);
        // .on("mouseleave", line_mouseleave);

        // svg.select("myLines:nth-child(1)").on("click", medicarea_mouseclick);
        // Add the points
        svg
          // First we need to enter in a group
          .selectAll("myDots")
          .data(dataReady)
          .enter()
          .append("g")
          .style("fill", function (d) {
            return myColor(d.name);
          })
          // Second we need to enter in the 'values' part of this group
          .selectAll("myPoints")
          .data(function (d) {
            return d.values;
          })
          .enter()
          .append("circle")
          .attr("cx", function (d) {
            return x(d.date);
          })
          .attr("cy", function (d) {
            return y(d.value);
          })
          .attr("r", 5)
          .attr("stroke", "white")
          .on("mouseover", point_mouseover)
          .on("mousemove", point_mousemove)
          .on("mouseleave", point_mouseleave);

        svg
          .selectAll("mydots")
          .data(dataReady)
          .enter()
          .append("circle")
          .attr("cx", 0)
          .attr("cy", function (d, i) {
            return 595 + i * 25;
          }) // 100 is where the first dot appears. 25 is the distance between dots
          .attr("r", 7)
          .style("fill", function (d) {
            return myColor(d.name);
          });

        svg
          .selectAll("myLegend")
          .data(dataReady)
          .enter()
          .append("text")
          .attr("x", 20)
          .attr("y", function (d, i) {
            return 600 + i * 25;
          }) // 100 is where the first dot appears. 25 is the distance between dots
          .style("fill", function (d) {
            return myColor(d.name);
          })
          .text(function (d) {
            return d.name;
          })
          .attr("text-anchor", "left")
          .style("alignment-baseline", "middle")
          .on("click", function (d) {
            // is the element currently visible ?
            currentOpacity = d3.selectAll("." + d.name).style("opacity");
            // Change the opacity: from 0 to 1 or from 1 to 0
            d3.selectAll("." + d.name)
              .transition()
              .style("opacity", currentOpacity == 1 ? 0 : 1);
          });

        document.getElementById("medi_a").onclick = function () {
          window.location.href = "medicare_part_a.html";
        };
        document.getElementById("medi_b").onclick = function () {
          window.location.href = "medicare_part_b.html";
        };
        document.getElementById("medi_d").onclick = function () {
          window.location.href = "medicare_part_d.html";
        };
        document.getElementById("soc_sec").onclick = function () {
          window.location.href = "socsec.html";
        };
      }
    </script>
  </body>
</html>
